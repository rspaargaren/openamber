esp32:
  board: esp32dev
  framework:
    type: esp-idf

esphome:
  name: openamber
  friendly_name: OpenAmber
  project:
    name: jordi.openamber
    version: 0.0.4
  includes: 
    - openamber.h

interval:
  - interval: 10s
    then:
      - if:
         condition:
          - switch.is_on: amber_controller_active
          - binary_sensor.is_on: modbus_inside_online
          - binary_sensor.is_on: modbus_outside_online
         then:
          - lambda: |-
              AMBER.loop();

logger:
  level: INFO
  baud_rate: 0

api:

ota:
  - platform: esphome
  - platform: http_request

http_request:
  buffer_size_tx: 1024

update:
  - platform: http_request
    name: Firmware Update
    source: https://github.com/Jordi1990/openamber/releases/latest/download/manifest.json

web_server:
  port: 80
  version: 3
  sorting_groups:
    - id: control_inside
      name: "Bediening binnen unit"
    - id: control_outside
      name: "Bediening buiten unit"
    - id: sensors_inside
      name: "Sensoren binnen unit"
    - id: sensors_outside
      name: "Sensoren buiten unit"
    - id: settings
      name: "Settings"

wifi:
  ap:
    ssid: "OpenAmber"
    password: "openamber"

captive_portal:    

uart:
  rx_pin: GPIO32
  tx_pin: GPIO33
  baud_rate: 19200
  parity: EVEN

globals:
  - id: modbus_inside_is_online
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: modbus_outside_is_online
    type: bool
    restore_value: no
    initial_value: 'false'

modbus:
  flow_control_pin: GPIO14
  send_wait_time: 500ms

modbus_controller:
- id: modbus_outside_unit
  address: 0x2
  update_interval: 30s
  command_throttle: 500ms
  max_cmd_retries: 3
  on_offline:
    then:
      - lambda: |-
          id(modbus_outside_is_online) = false;
      - logger.log: "Modbus outside unit OFFLINE"
  on_online:
    then:
      - lambda: |-
          id(modbus_outside_is_online) = true;
      - logger.log: "Modbus outside unit ONLINE"
- id: modbus_inside_unit
  address: 0x0B
  update_interval: 30s
  command_throttle: 500ms
  max_cmd_retries: 3
  on_offline:
    then:
      - lambda: |-
          id(modbus_inside_is_online) = false;
      - logger.log: "Modbus inside unit OFFLINE"
  on_online:
    then:
      - lambda: |-
          id(modbus_inside_is_online) = true;
      - logger.log: "Modbus inside unit ONLINE"

climate:
  - platform: thermostat
    id: climate_controller
    name: Amber thermostat
    sensor: room_temperature
    set_point_minimum_differential: 4.0

    min_cooling_off_time: 15min
    min_cooling_run_time: 1h # Min 1h run
    min_heating_off_time: 15min
    min_heating_run_time: 1h # Min 1h run
    min_idle_time: 15min
    default_preset: Comfort

    # Hysteresis
    heat_deadband: 0.3
    heat_overrun: 0.2

    cool_deadband: 0.5
    cool_overrun: 3.0

    heat_action: 
      then:
        - logger.log: "Start heating"    
    cool_action: 
      then:
        - logger.log: "Start cooling"    
    idle_action: 
      then:
        - logger.log: "Start idling"

    # Presets
    preset:
      - name: Comfort
        default_target_temperature_low: 20.5 °C
        default_target_temperature_high: 24 °C

  # TODO: Find a way to set PID values from settings and maybe different profiles for heating/cooling/dhw.
  - platform: pid
    id: pid_heat_cool_temperature_control
    internal: True
    sensor: heat_cool_temperature_tc
    default_target_temperature: 30°C
    heat_output: pid_heat_output
    cool_output: pid_cool_output
    control_parameters:
      kp: 0.6
      ki: 0.002
      kd: 0.7
    deadband_parameters:
      threshold_low: -1
      threshold_high: 1
      deadband_output_averaging_samples: 6
    visual:
      min_temperature: 10
      max_temperature: 45

output:
  - platform: template
    id: pid_heat_output
    type: float
    write_action:
      - lambda: |-
          AMBER.WriteHeatPIDValue(state);

  - platform: template
    id: pid_cool_output
    type: float
    write_action:
      - logger.log:
         format: "Write cool pids"
         level: DEBUG
      # TODO: Store in seperate pid field
      # - lambda: |-
      #     AMBER.WritePIDValue(state);

sensor:
- platform: template
  id: backup_heater_degmin_current_sensor
  name: "Backup heater degree/min current"
  unit_of_measurement: "°C·min"
  accuracy_decimals: 1
  state_class: measurement

- platform: pulse_counter
  pin: GPIO35
  name: Pulse meter
  id: water_flow_rate
  device_class: volume_flow_rate
  unit_of_measurement: L/min
  filters:
    - lambda: return (x / id(flow_sensor_calibration).state);
  total:
    name: Total pulses
    unit_of_measurement: l
    filters:
      - lambda: return x / id(flow_sensor_calibration).state;
      - delta: 1
          
- platform: uptime
  name: "Uptime"
  id: sensor_uptime
  update_interval: 60s
  device_class: duration
  unit_of_measurement: s
  state_class: total_increasing

- platform: wifi_signal
  name: WiFi signal dB
  id: wifi_signal_db
  update_interval: 20s

- platform: template
  id: temperature_outside_ta_avg_1h
  name: "Buiten temperatuur (1h gemiddelde)"
  internal: true
  unit_of_measurement: "°C"
  accuracy_decimals: 1
  update_interval: 15s
  lambda: |-
    return id(temperature_outside_ta).state;
  filters:
    - median:
        window_size: 5
        send_every: 1
    - sliding_window_moving_average:
        window_size: 240
        send_every: 1

- platform: template
  id: current_setpoint
  name: "Huidig setpoint"
  unit_of_measurement: "°C"
  accuracy_decimals: 0
  update_interval: never
  lambda: |-
    if (id(heat_mode_select).current_option() == "Stooklijn")
    {
      return id(heat_curve_calculated_setpoint).state;
    }
    else
    {
      return id(manual_setpoint).state;
    }
  on_value:
    - lambda: |-
        auto call = id(pid_heat_cool_temperature_control).make_call();
        call.set_target_temperature(x);
        call.perform();

- platform: template
  id: heat_curve_calculated_setpoint
  name: "Stooklijn berekend setpoint"
  internal: True
  unit_of_measurement: "°C"
  accuracy_decimals: 0
  update_interval: 15s
  lambda: |-
    const float Ta = id(temperature_outside_ta_avg_1h).state;

    const float tc15  = id(heat_curve_p15).state;
    const float tc10  = id(heat_curve_p10).state;
    const float tc5   = id(heat_curve_p5).state;
    const float tc0   = id(heat_curve_0).state;
    const float tc_m10 = id(heat_curve_m10).state;
    auto lerp = [](float x, float x0, float y0, float x1, float y1) -> float {
      const float t = (x - x0) / (x1 - x0);
      return y0 + t * (y1 - y0);
    };

    float tc;
    if (Ta >= 15.0f)       tc = tc15;
    else if (Ta >= 10.0f)  tc = lerp(Ta, 15.0f, tc15, 10.0f, tc10);
    else if (Ta >= 5.0f)   tc = lerp(Ta, 10.0f, tc10, 5.0f, tc5);
    else if (Ta >= 0.0f)   tc = lerp(Ta, 5.0f, tc5, 0.0f, tc0);
    else if (Ta >= -10.0f) tc = lerp(Ta, 0.0f, tc0, -10.0f, tc_m10);
    else                   tc = tc_m10;

    return tc;
  on_value: 
    then:
      - component.update: current_setpoint
  filters:
    - round_to_multiple_of: 1
    - delta: 1

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: room_temperature
  name: "Ruimte temperatuur (Tr)"
  address: 1199
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  register_count: 16 # 1199 - 1214
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: dhw_temperature_tw_sensor
  name: "Tapwatertemperatuur (Tw)"
  address: 1200
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: heat_cool_temperature_tc
  name: "CV-aanvoertemperatuur (Tc)"
  address: 1201
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01
    - throttle: 30s # Throttle because PID loop depends on this

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: outlet_temperature_tuo
  name: "CV-aanvoertemperatuur (Tuo)"
  address: 1202
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: inlet_temperature_tui
  name: "CV-retourtemperatuur (Tui)"
  address: 1203
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01
  on_raw_value: 
    then:
      - number.set: 
          id: outlet_temperature_outside
          value: !lambda "return x;"

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Condensatietemperatuur (Tup)"
  address: 1204
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Cv-aanvoertemperatuur zone 1 (Tv1)"
  address: 1207
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Cv-aanvoertemperatuur zone 2 (Tv2)"
  address: 1208
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: pump_p0_current_pwm_sensor
  name: "Pomp P0 PWM"
  address: 1303
  register_type: holding
  value_type: S_WORD
  unit_of_measurement: "%"
  state_class: "measurement"
  filters:
    - lambda: |-
        return ((x * -1) + 1000) / 10;
  web_server: 
    sorting_group_id: sensors_inside
  on_value: 
    then:
      - lambda: 
          id(modbus_inside_is_online) = true;

# Outside unit
- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Voltage buitenunit"
  address: 2100
  register_type: holding
  value_type: S_WORD
  device_class: "voltage"
  unit_of_measurement: "V"
  accuracy_decimals: 0
  state_class: "measurement"
  register_count: 33 # 2100-2132
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Stroom buitenunit"
  address: 2101
  register_type: holding
  value_type: S_WORD
  device_class: "current"
  accuracy_decimals: 1
  unit_of_measurement: "A"
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - multiply: 0.1

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Compressor setpoint frequentie"
  address: 2102
  register_type: holding
  value_type: S_WORD
  device_class: frequency
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: Hz
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: current_compressor_frequency
  name: "Compressor frequentie"
  address: 2103
  register_type: holding
  value_type: S_WORD
  device_class: frequency
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: Hz
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Fan RPM setpoint"
  address: 2104
  register_type: holding
  value_type: S_WORD
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: rpm
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Fan RPM"
  address: 2105
  register_type: holding
  value_type: S_WORD
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: rpm
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Expansieklep"
  address: 2107
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Buiten unit state"
  register_type: holding
  address: 2108
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: temperature_outside_ta
  name: "Buitentemperatuur (Ta)"
  address: 2110
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Verdampingstemperatuur (Tp)"
  address: 2111
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Persgastemperatuur (Td)"
  address: 2112
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Zuigastemperatuur (Ts)"
  address: 2113
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C     
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Zuiggasdruk (Ps)"
  address: 2116
  register_type: holding
  value_type: S_WORD
  device_class: pressure
  accuracy_decimals: 1
  state_class: measurement
  unit_of_measurement: bar
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - multiply: 0.1

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Persgasdruk (Pd)"
  address: 2117
  register_type: holding
  value_type: S_WORD
  device_class: pressure
  accuracy_decimals: 1
  state_class: measurement
  unit_of_measurement: bar
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - multiply: 0.1

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outside_unit_program_version
  internal: True
  skip_updates: 10
  address: 2122
  register_type: holding
  value_type: S_WORD
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "EEPROM"
  skip_updates: 10
  address: 2123
  register_type: holding
  value_type: S_WORD
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Condensing Temperature"
  register_type: holding
  address: 2131
  unit_of_measurement: "°C"
  device_class: "temperature"
  state_class: "measurement"
  accuracy_decimals: 2
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Evaporating Temperature"
  register_type: holding
  address: 2132
  unit_of_measurement: "°C"
  device_class: "temperature"
  state_class: "measurement"
  accuracy_decimals: 2
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outside_unit_eeprom_version_part2
  internal: True
  skip_updates: 10
  address: 3509
  register_type: holding
  value_type: S_WORD
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outside_unit_eeprom_version_part1
  internal: True
  skip_updates: 10
  address: 3510
  register_type: holding
  value_type: S_WORD
  web_server: 
    sorting_group_id: sensors_outside

text_sensor:
  - platform: template
    name: "Buiten unit EEPROM versie"
    update_interval: 60s
    web_server: 
     sorting_group_id: sensors_outside
    lambda: |-
      if (!id(outside_unit_program_version).has_state() ||
          !id(outside_unit_eeprom_version_part1).has_state() ||
          !id(outside_unit_eeprom_version_part2).has_state()) {
        return {};
      }

      int v1 = (int)id(outside_unit_program_version).state;
      int v2 = (int)id(outside_unit_eeprom_version_part1).state;
      int v3 = (int)id(outside_unit_eeprom_version_part2).state;

      char buffer[20];
      snprintf(buffer, sizeof(buffer), "V%04X,%d%d", v1, v2, v3);
      return std::string(buffer);
    icon: "mdi:chip"

  - platform: template
    id: state_machine_state
    name: "Control loop state"
    icon: "mdi:state-machine"
    update_interval: never

binary_sensor:
  - platform: template
    name: "Tapwater vraag"
    id: dhw_demand_active_sensor
    device_class: running
    lambda: |-
        float restart_delta = id(dhw_restart_dhw_delta).state;
        float tw = id(dhw_temperature_tw_sensor).state;
        float setpoint = id(dhw_setpoint_temperature).state;

        return (setpoint - tw) >= restart_delta;

  - platform: template
    name: "Warmtevraag"
    id: heat_demand_active_sensor
    device_class: running
    lambda: |-
      if (id(thermostat_mode_select).current_option() == "Intern")
      {
        return id(climate_controller).action == climate::CLIMATE_ACTION_HEATING;
      }
      else
      {
        return id(external_heat_demand).state;
      }

  - platform: template
    name: "Koudevraag"
    id: cool_demand_active_sensor
    device_class: running
    lambda: |-
      if (id(thermostat_mode_select).current_option() == "Intern")
      {
        return id(climate_controller).action == climate::CLIMATE_ACTION_COOLING;
      }
      else
      {
        return id(external_cool_demand).state;
      }

  - platform: template
    name: "Vorstbescherming 1e trap"
    id: frost_protection_stage1_active
    filters:
      - delayed_on_off: 300s
    lambda: |-
      return id(temperature_outside_ta).state < id(frost_protection_stage_1_temp_ta).state;
    on_press: 
      then:
        - logger.log:
            format: "Pump interval reset due to pump required for frost protection."
            level: INFO
        - lambda: |-
            AMBER.ResetPumpInterval();  

  - platform: template
    name: "Vorstbescherming 2e trap"
    id: frost_protection_stage2_active
    filters:
      - delayed_on_off: 300s
    lambda: |-
      return id(temperature_outside_ta).state < id(frost_protection_stage_2_temp_ta).state &&
             id(inlet_temperature_tui).state < id(frost_protection_stage_2_temp_tui).state;
    on_press: 
      then:
        - logger.log:
            format: "Pump interval reset due to pump required for frost protection."
            level: INFO
        - lambda: |-
            AMBER.ResetPumpInterval();

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    id: internal_pump_active
    name: "Pomp P0"
    address: 1212
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    id: external_cool_demand
    name: "Externe koudevraag"
    address: 1213
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    id: external_heat_demand
    name: "Externe warmtevraag"
    address: 1214
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Pomp P1"
    address: 1300
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Pomp P2"
    address: 1301
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    id: dhw_pump_active_sensor
    name: "Tapwater pomp"
    address: 1302
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "3-weg klep"
    address: 1305
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    id: backup_heater_active_sensor
    name: "Verwarmingselement"
    address: 1309
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Fan Low Speed Mode"
    register_type: holding
    address: 2108
    bitmask: 0x1
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Bodemplaat verwarming"
    register_type: holding
    address: 2108
    bitmask: 0x4
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Carterverwarming"
    register_type: holding
    address: 2108
    bitmask: 0x8
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Fan Defrost Speed Mode"
    register_type: holding
    address: 2108
    bitmask: 0x10
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Fan High Speed Mode"
    register_type: holding
    address: 2108
    bitmask: 0x20
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "4-weg klep switching"
    register_type: holding
    address: 2108
    bitmask: 0x40
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Expansion Valve Lock"
    register_type: holding
    address: 2108
    bitmask: 0x80
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Pump Relay"
    register_type: holding
    address: 2108
    bitmask: 0x800
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Defrost"
    id: defrost_active_sensor
    icon: mdi:snowflake
    register_type: holding
    address: 2118
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Bedrijfstroom warmtepomp (P01)"
    register_type: holding
    address: 2119
    bitmask: 0x0001
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Bedrijfstroom warmtepomp (P02)"
    register_type: holding
    address: 2119
    bitmask: 0x0002
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing compressorstart (P03)"
    register_type: holding
    address: 2119
    bitmask: 0x0004
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    id: oil_return_cycle_active
    name: "Olie-terugloopcyclus (P04)"
    icon: mdi:autorenew
    register_type: holding
    address: 2119
    bitmask: 0x0008
    device_class: running
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Hogedrukbeveiliging (P05)"
    register_type: holding
    address: 2119
    bitmask: 0x0010
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Laag drukverschil (P06)"
    register_type: holding
    address: 2119
    bitmask: 0x0020
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Compressor voorverwarming (P07)"
    register_type: holding
    address: 2119
    bitmask: 0x0040
    device_class: running
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing sensor persgasdruk (P08)"
    register_type: holding
    address: 2119
    bitmask: 0x0080
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing sensor verdamper/condensor (P09)"
    register_type: holding
    address: 2119
    bitmask: 0x0100
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Voedingsspanning (P10)"
    register_type: holding
    address: 2119
    bitmask: 0x0200
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Compressor begrenzing (P11)"
    register_type: holding
    address: 2119
    bitmask: 0x0400
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Compressor begrenzing (P12)"
    register_type: holding
    address: 2119
    bitmask: 0x0800
    device_class: running
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Laag drukverschil (P13)"
    register_type: holding
    address: 2119
    bitmask: 0x1000
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing buitentemperatuursensor (F01)"
    register_type: holding
    address: 2120
    bitmask: 0x0001
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing sensor verdamper/condensor (F02)"
    register_type: holding
    address: 2120
    bitmask: 0x0002
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing persgas temperatuursensor (F03)"
    register_type: holding
    address: 2120
    bitmask: 0x0004
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing zuigas temperatuursensor (F04)"
    register_type: holding
    address: 2120
    bitmask: 0x0008
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing zuiggas druk sensor (F05)"
    register_type: holding
    address: 2120
    bitmask: 0x0010
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing persgas druk sensor (F06)"
    register_type: holding
    address: 2120
    bitmask: 0x0020
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing hogedrukbeveiliging (F07)"
    register_type: holding
    address: 2120
    bitmask: 0x0040
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing ventilatormotor DC (F09)"
    register_type: holding
    address: 2120
    bitmask: 0x0100
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Communicatiefout PCB (E01)"
    register_type: holding
    address: 2121
    bitmask: 0x0001
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing inverter communicatie (E02)"
    register_type: holding
    address: 2121
    bitmask: 0x0002
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Bedrijfsstroom warmtepomp (E03)"
    register_type: holding
    address: 2121
    bitmask: 0x0004
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Bedrijfsstroom warmtepomp (E04)"
    register_type: holding
    address: 2121
    bitmask: 0x0008
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing inverter (E05)"
    register_type: holding
    address: 2121
    bitmask: 0x0010
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing VCD-module (E06)"
    register_type: holding
    address: 2121
    bitmask: 0x0020
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing voedingsspanning (E07)"
    register_type: holding
    address: 2121
    bitmask: 0x0040
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing EEPROM warmtepomp (E08)"
    register_type: holding
    address: 2121
    bitmask: 0x0080
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing ventilatormotor DC (F10)"
    register_type: holding
    address: 2121
    bitmask: 0x0100
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing sensor aanvoertemperatuur Tuo (F16)"
    register_type: holding
    address: 2121
    bitmask: 0x0200
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing sensor retourtemperatuur Tui (F17)"
    register_type: holding
    address: 2121
    bitmask: 0x0400
    device_class: problem
    entity_category: diagnostic

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Storing sensor condensortemperatuur Tup (F18)"
    register_type: holding
    address: 2121
    bitmask: 0x0800
    device_class: problem
    entity_category: diagnostic

  - platform: template
    id: modbus_inside_online
    name: "Modbus binnenunit"
    device_class: connectivity
    lambda: |-
      return id(modbus_inside_is_online);

  - platform: template
    id: modbus_outside_online
    name: "Modbus buitenunit"
    device_class: connectivity
    lambda: |-
      return id(modbus_outside_is_online);

number:
- platform: template
  name: Flow sensor calibration
  id: flow_sensor_calibration
  min_value: 1
  max_value: 1000
  mode: box
  step: 1
  restore_value: true
  optimistic: true
  unit_of_measurement: pulses/l
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Vorstbescherming 1e trap buiten temperatuur(Ta)"
  id: frost_protection_stage_1_temp_ta
  optimistic: true
  min_value: 0
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 8.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Vorstbescherming 2e trap buiten temperatuur(Ta)"
  id: frost_protection_stage_2_temp_ta
  optimistic: true
  min_value: 0
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 6.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Vorstbescherming 2e trap water temperatuur (Tui)"
  id: frost_protection_stage_2_temp_tui
  optimistic: true
  min_value: 0
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 7.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Compressor start delta"
  id: compressor_start_delta
  optimistic: true
  min_value: 0.1
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 3.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Compressor stop delta"
  id: compressor_stop_delta
  optimistic: true
  min_value: 0.1
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 5.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: heat_curve_p15
  name: "Stooklijn @ +15°C"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 15
  max_value: 45
  step: 1
  restore_value: true
  initial_value: 25
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: heat_curve_p10
  name: "Stooklijn @ +10°C"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 15
  max_value: 45
  step: 1
  restore_value: true
  initial_value: 27
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: heat_curve_p5
  name: "Stooklijn Tc @ +5°C"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 15
  max_value: 45
  step: 1
  restore_value: true
  initial_value: 28
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: heat_curve_0
  name: "Stooklijn Tc  0°C"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 15
  max_value: 45
  step: 1
  restore_value: true
  initial_value: 30
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: heat_curve_m10
  name: "Stooklijn Tc @ -10°C"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 15
  max_value: 45
  step: 1
  restore_value: true
  initial_value: 32
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: manual_setpoint
  name: "Handmatig setpoint Cv-aanvoertemperatuur"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 15
  max_value: 45
  step: 1
  initial_value: 30
  entity_category: config
  on_value: 
    then:
      - component.update: current_setpoint
  web_server: 
      sorting_group_id: settings

- platform: template
  id: dhw_setpoint_temperature
  name: "Tapwater temperatuur setpoint"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 25
  max_value: 75
  step: 1
  initial_value: 55
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: dhw_restart_dhw_delta
  name: "∆T herstart tapwater verwarmen"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: 5
  max_value: 25
  step: 1
  initial_value: 15
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: dhw_temperature_threshold_max_compressor_mode
  name: "Buitentemperatuur Tapwater winter vermogen"
  optimistic: True
  unit_of_measurement: "°C"
  device_class: "temperature"
  min_value: -20
  max_value: 10
  step: 1
  initial_value: 5
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: backup_heater_degmin_threshold
  name: "Backup element graadminuten"
  unit_of_measurement: "°C·min"
  min_value: 0
  max_value: 800
  initial_value: 240
  step: 5
  optimistic: true
  restore_value: true
  entity_category: config
  icon: mdi:heat-wave
  web_server: 
      sorting_group_id: settings

- platform: template
  id: pump_speed_heating_number
  name: "Pomp snelheid verwarmen"
  optimistic: True
  min_value: 0
  max_value: 100
  step: 1
  unit_of_measurement: "%"
  initial_value: 100
  restore_value: True
  entity_category: config
  web_server: 
    sorting_group_id: settings

- platform: template
  id: pump_speed_dhw_number
  name: "Pomp snelheid tapwater"
  optimistic: True
  min_value: 0
  max_value: 100
  step: 1
  unit_of_measurement: "%"
  initial_value: 100
  restore_value: True
  entity_category: config
  web_server: 
    sorting_group_id: settings

- platform: modbus_controller
  id: pump_control_pwm_number
  modbus_controller_id: modbus_inside_unit
  name: "Pomp PWM"
  address: 1103
  min_value: 0
  max_value: 1000
  web_server: 
    sorting_group_id: control_inside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outlet_temperature_outside
  name: "CV-aanvoertemperatuur - Buiten"
  address: 2005
  register_type: holding
  value_type: S_WORD
  internal: True
  mode: box
  web_server: 
      sorting_group_id: control_outside

- platform: template
  name: "Pomp interval (minuten)"
  id: pump_interval
  optimistic: True
  restore_value: True
  min_value: 5
  max_value: 60
  step: 1
  unit_of_measurement: "min"
  icon: "mdi:timer-outline"
  initial_value: 15
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Pomp duur (minuten)"
  id: pump_duration
  optimistic: True
  restore_value: True
  min_value: 2
  max_value: 10
  step: 1
  unit_of_measurement: "min"
  icon: "mdi:clock-outline"
  initial_value: 2
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  id: defrost_backup_heater_boost_temperature_sensor
  name: "Defrost boost buitentemperatuur"
  optimistic: True
  restore_value: True
  initial_value: -3
  step: 1
  min_value: -15
  max_value: 15
  unit_of_measurement: "°C"
  device_class: "temperature"
  entity_category: config
  web_server: 
    sorting_group_id: settings

switch:
 - platform: gpio
   pin: GPIO22
   name: "Relais verwarming"
   id: relay_heating
   icon: mdi:electric-switch
   restore_mode: RESTORE_DEFAULT_OFF

 - platform: gpio
   pin: GPIO23
   name: "Relais koelen"
   id: relay_cooling
   icon: mdi:electric-switch
   restore_mode: RESTORE_DEFAULT_OFF

 - platform: template
   id: dhw_enabled_switch
   name: "Tapwater aanwezig"
   optimistic: True
   restore_mode: RESTORE_DEFAULT_OFF
   entity_category: config
   web_server: 
    sorting_group_id: settings

 - platform: template
   id: amber_controller_active
   name: "Amber controller actief"
   optimistic: True
   restore_mode: ALWAYS_ON

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: pump_p0_relay_switch
   internal: True
   name: "Pomp P0 relais"
   address: 1099
   register_type: holding
   web_server: 
     sorting_group_id: control_inside
     
 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: pump_p1_relay_switch
   internal: True
   name: "Pomp P1 relais"
   address: 1100
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: pump_p2_relay_switch
   internal: True
   name: "Pomp P2 relais"
   address: 1101
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: dhw_pump_relay_switch
   internal: True
   name: "Tapwater pomp relais"
   address: 1102
   register_type: holding
   web_server: 
     sorting_group_id: control_inside
     
 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: initialize_relay_switch
   internal: True
   name: "Binnen unit relais onbekend"
   address: 1104
   register_type: holding
   web_server: 
    sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   internal: True
   id: three_way_valve_heat_cool_switch
   name: "3-weg klep Koelen/Verwarmen"
   address: 1105
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: backup_heater_stage_1
   internal: True
   name: "Backup heater stage 1"
   address: 1109
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: backup_heater_stage_2
   internal: True
   name: "Backup heater stage 2"
   address: 1110
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   internal: True
   id: three_way_valve_dhw_switch
   name: "3-weg klep SWW"
   address: 1112
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: template
   optimistic: True
   id: backup_heater_relay
   name: "Backup verwarmingselement"
   on_state: 
     then:
      - switch.control:
          id: backup_heater_stage_1
          state: !lambda return x;
      - switch.control:
          id: backup_heater_stage_2
          state: !lambda return x;

select:
  - platform: template
    id: heat_compressor_mode
    name: "Verwarmen vermogen"
    optimistic: True
    options:
      - "Beperkt"
      - "Zeer laag"
      - "Laag"
      - "Gemiddeld"
      - "Verhoogd"
      - "Hoog"
      - "Maximaal"
    initial_option: "Maximaal"
    entity_category: config
    web_server: 
        sorting_group_id: settings

  - platform: template
    id: dhw_compressor_mode
    name: "Tapwater basisvermogen"
    optimistic: True
    options:
      - "Beperkt"
      - "Zeer laag"
      - "Laag"
      - "Gemiddeld"
      - "Verhoogd"
      - "Hoog"
      - "Maximaal"
    initial_option: "Beperkt"
    entity_category: config
    web_server: 
        sorting_group_id: settings

  - platform: template
    id: dhw_compressor_mode_max
    name: "Tapwater wintervermogen"
    optimistic: True
    options:
      - "Gemiddeld"
      - "Verhoogd"
      - "Hoog"
      - "Maximaal"
    initial_option: "Gemiddeld"
    entity_category: config
    web_server: 
        sorting_group_id: settings

  - platform: template
    id: three_way_valve_select
    name: "3-weg klep stand"
    optimistic: True
    options:
      - "Verwarmen/Koelen"
      - "Tapwater"
    initial_option: "Verwarmen/Koelen"
    entity_category: config
    web_server: 
      sorting_group_id: control_inside
    on_value: 
      then:
       - if:
           condition:
             lambda: 'return id(three_way_valve_select).current_option() == "Verwarmen/Koelen";'
           then:
             - switch.turn_off: three_way_valve_dhw_switch
             - switch.turn_on: three_way_valve_heat_cool_switch
           else:
             - switch.turn_on: three_way_valve_dhw_switch
             - switch.turn_off: three_way_valve_heat_cool_switch

  - platform: template
    id: heat_mode_select
    name: "Verwarmingsmodus"
    optimistic: True
    options:
      - "Stooklijn"
      - "Extern setpoint"
    initial_option: "Stooklijn"
    restore_value: True
    entity_category: config
    web_server: 
      sorting_group_id: settings
    on_value: 
      then:
        - component.update: current_setpoint

  - platform: template
    id: thermostat_mode_select
    name: "Thermostaat keuze"
    optimistic: True
    options:
      - "Intern"
      - "Extern"
    initial_option: "Intern"
    restore_value: True
    entity_category: config
    web_server: 
      sorting_group_id: settings

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    id: compressor_control_select
    name: "Compressor stand (Buiten)"
    address: 1999
    value_type: S_WORD
    web_server: 
     sorting_group_id: control_outside
    optionsmap:
      "0": 0
      "1": 1
      "2": 2
      "3": 3
      "4": 4
      "5": 5
      "6": 6
      "7": 7
      "8": 8
      "9": 9
      "10": 10
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    id: working_mode_switch
    name: "Bedrijfsmodus"
    address: 3999
    on_value: 
      then:
        - lambda: 
            id(modbus_outside_is_online) = true;
    web_server: 
     sorting_group_id: control_outside
    optionsmap:
      "Standby": 0
      "Koelen": 1
      "Verwarmen": 2

button:
  - platform: factory_reset
    name: Restart with Factory Default Settings
