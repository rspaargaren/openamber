esp32:
  board: esp32dev
  framework:
    type: esp-idf

esphome:
  name: openamber
  friendly_name: OpenAmber
  project:
    name: jordi.openamber
    version: 0.0.1
  includes: 
    - openamber.h
  on_boot:
    priority: -100 # Start after everything is initialized
    then:          
      # Initialize amber controller
      - lambda: |-
          AMBER.init(
            id(working_mode_switch),
            id(compressor_control),
            id(heat_cool_temperature_tc),
            id(inlet_temperature_tui),
            id(temperature_outside_ta),
            id(room_temperature),
            id(pump_interval),
            id(pump_duration),
            id(compressor_current_setpoint),
            id(compressor_pid_climate),
            id(pid_heat_output),
            id(pid_cool_output),
            id(climate_controller),
            id(pump_state),
            id(internal_pump_active),
            id(frost_protection_stage1_active),
            id(frost_protection_stage2_active),
            id(compressor_start_delta),
            id(compressor_stop_delta),
            id(state_machine_state),
            id(oil_return_cycle_active)
          );

interval:
  - interval: 10s
    then:
      - if:
         condition:
          - switch.is_on: amber_controller_active
          - binary_sensor.is_on: modbus_inside_online
          - binary_sensor.is_on: modbus_outside_online
         then:
          - lambda: |-
              AMBER.loop();

logger:
  level: INFO
  baud_rate: 0

api:

ota:
  - platform: esphome
  - platform: http_request

http_request:
  buffer_size_tx: 1024

update:
  - platform: http_request
    name: Firmware Update
    source: https://github.com/Jordi1990/openamber/releases/latest/download/manifest.json

web_server:
  port: 80
  version: 3
  sorting_groups:
    - id: control_inside
      name: "Bediening binnen unit"
    - id: control_outside
      name: "Bediening buiten unit"
    - id: sensors_inside
      name: "Sensoren binnen unit"
    - id: sensors_outside
      name: "Sensoren buiten unit"
    - id: settings
      name: "Settings"

wifi:
  ap:
    ssid: "OpenAmber"
    password: "openamber"

captive_portal:    

uart:
  rx_pin: GPIO32
  tx_pin: GPIO33
  baud_rate: 19200
  parity: EVEN

globals:
  - id: modbus_inside_is_online
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: modbus_outside_is_online
    type: bool
    restore_value: no
    initial_value: 'false'

modbus:
  flow_control_pin: GPIO14
  send_wait_time: 500ms

modbus_controller:
- id: modbus_outside_unit
  address: 0x2
  update_interval: 15s
  command_throttle: 250ms
  max_cmd_retries: 3
  offline_skip_updates: 10
  on_offline:
    then:
      - lambda: |-
          id(modbus_outside_is_online) = false;
      - logger.log: "Modbus outside unit OFFLINE"
  on_online:
    then:
      - lambda: |-
          id(modbus_outside_is_online) = true;
      - logger.log: "Modbus outside unit ONLINE"
- id: modbus_inside_unit
  address: 0x0B
  update_interval: 15s
  command_throttle: 250ms
  max_cmd_retries: 3
  offline_skip_updates: 10
  on_offline:
    then:
      - lambda: |-
          id(modbus_inside_is_online) = false;
      - logger.log: "Modbus inside unit OFFLINE"
  on_online:
    then:
      - lambda: |-
          id(modbus_inside_is_online) = true;
      - logger.log: "Modbus inside unit ONLINE"

climate:
  - platform: thermostat
    id: climate_controller
    name: Amber thermostat
    sensor: room_temperature
    set_point_minimum_differential: 4.0

    startup_delay: true # Wait 15min after power cycle
    min_cooling_off_time: 15min
    min_cooling_run_time: 1h # Min 1h run
    min_heating_off_time: 15min
    min_heating_run_time: 1h # Min 1h run
    min_idle_time: 15min
    default_preset: Comfort

    # Hysteresis
    heat_deadband: 0.3
    heat_overrun: 0.2

    cool_deadband: 0.5
    cool_overrun: 3.0

    heat_action: 
      then:
        - logger.log: "Start heating"    
    cool_action: 
      then:
        - logger.log: "Start cooling"    
    idle_action: 
      then:
        - logger.log: "Start idling"

    # Presets
    preset:
      - name: Comfort
        default_target_temperature_low: 20.5 °C
        default_target_temperature_high: 24 °C

  # TODO: Find a way to set PID values from settings and maybe different profiles for heating/cooling/dhw.
  - platform: pid
    id: compressor_pid_climate
    internal: False # TODO: Maybe don't expose this but only a setpoint.
    name: "Compressor PID Climate"
    sensor: heat_cool_temperature_tc
    default_target_temperature: 30°C
    heat_output: pid_heat_output
    cool_output: pid_cool_output
    control_parameters:
      kp: 0.6
      ki: 0.003
      kd: 0.7
    deadband_parameters:
      threshold_low: -1
      threshold_high: 1
    visual:
      min_temperature: 10
      max_temperature: 45

output:
  - platform: template
    id: pid_heat_output
    type: float
    write_action:
      - lambda: |-
          AMBER.WritePIDValue(state);

  - platform: template
    id: pid_cool_output
    type: float
    write_action:
      - logger.log:
         format: "Write cool pids"
         level: DEBUG
      # TODO: Store in seperate pid field
      # - lambda: |-
      #     AMBER.WritePIDValue(state);

sensor:
- platform: pulse_counter
  pin: GPIO35
  name: Pulse meter
  id: water_flow_rate
  device_class: volume_flow_rate
  unit_of_measurement: L/min
  filters:
    - lambda: return (x / id(flow_sensor_calibration).state);
  total:
    name: Total pulses
    unit_of_measurement: l
    filters:
      - lambda: return x / id(flow_sensor_calibration).state;
      - delta: 1
          
- platform: uptime
  name: "Uptime"
  id: sensor_uptime
  update_interval: 60s
  device_class: duration
  unit_of_measurement: s
  state_class: total_increasing

- platform: wifi_signal
  name: WiFi signal dB
  id: wifi_signal_db
  update_interval: 20s

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: room_temperature
  name: "Ruimte temperatuur (Tr)"
  address: 1199
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  register_count: 16 # 1199 - 1214
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Tapwatertemperatuur (Tw)"
  address: 1200
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: heat_cool_temperature_tc
  name: "CV-aanvoertemperatuur verwarmen/koelen (Tc)"
  address: 1201
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01
    - throttle: 30s # Throttle because PID loop depends on this

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: outlet_temperature_tuo
  name: "CV-aanvoertemperatuur (Tuo)"
  address: 1202
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  id: inlet_temperature_tui
  name: "CV-retourtemperatuur (Tui)"
  address: 1203
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01
  on_raw_value: 
    then:
      - number.set: 
          id: outlet_temperature_outside
          value: !lambda "return x;"

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Condensatietemperatuur (Tup)"
  address: 1204
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Heating/Cooling zone 1 watertemp (Tv1)"
  address: 1207
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Heating/Cooling zone 2 watertemp (Tv2)"
  address: 1208
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_inside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_inside_unit
  name: "Interne pomp stand"
  address: 1303
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_inside

# Outside unit
- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Voltage buitenunit"
  address: 2100
  register_type: holding
  value_type: S_WORD
  device_class: "voltage"
  unit_of_measurement: "V"
  accuracy_decimals: 0
  state_class: "measurement"
  register_count: 33 # 2100-2132
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Stroom buitenunit"
  address: 2101
  register_type: holding
  value_type: S_WORD
  device_class: "current"
  accuracy_decimals: 1
  unit_of_measurement: "A"
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - multiply: 0.1

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Compressor setpoint frequentie"
  address: 2102
  register_type: holding
  value_type: S_WORD
  device_class: frequency
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: Hz
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: compressor_current_setpoint
  name: "Compressor frequentie"
  address: 2103
  register_type: holding
  value_type: S_WORD
  device_class: frequency
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: Hz
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Fan RPM setpoint"
  address: 2104
  register_type: holding
  value_type: S_WORD
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: rpm
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Fan RPM"
  address: 2105
  register_type: holding
  value_type: S_WORD
  accuracy_decimals: 0
  state_class: measurement
  unit_of_measurement: rpm
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Expansion valve"
  address: 2107
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Buiten unit state"
  register_type: holding
  address: 2108
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: temperature_outside_ta
  name: "Buitentemperatuur (Ta)"
  address: 2110
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Verdampingstemperatuur (Tp)"
  address: 2111
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Persgastemperatuur (Td)"
  address: 2112
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C   
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Zuigastemperatuur (Ts)"
  address: 2113
  register_type: holding
  value_type: S_WORD
  device_class: temperature
  state_class: measurement
  unit_of_measurement: °C     
  accuracy_decimals: 1
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Zuiggasdruk (Ps)"
  address: 2116
  register_type: holding
  value_type: S_WORD
  device_class: pressure
  accuracy_decimals: 1
  state_class: measurement
  unit_of_measurement: bar
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - multiply: 0.1

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Persgasdruk (Pd)"
  address: 2117
  register_type: holding
  value_type: S_WORD
  device_class: pressure
  accuracy_decimals: 1
  state_class: measurement
  unit_of_measurement: bar
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - multiply: 0.1

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Alarm codes"
  address: 2119
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Status 1?"
  address: 2120
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Status 2?"
  address: 2121
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outside_unit_version_1
  internal: True
  name: "Buiten unit firmware versie 1"
  skip_updates: 10
  address: 2122
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "EEPROM"
  skip_updates: 10
  address: 2123
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Condensing Temperature"
  register_type: holding
  address: 2131
  unit_of_measurement: "°C"
  device_class: "temperature"
  state_class: "measurement"
  accuracy_decimals: 2
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  name: "Evaporating Temperature"
  register_type: holding
  address: 2132
  unit_of_measurement: "°C"
  device_class: "temperature"
  state_class: "measurement"
  accuracy_decimals: 2
  web_server: 
    sorting_group_id: sensors_outside
  filters:
    - offset: -3000
    - multiply: 0.01

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outside_unit_version_2
  internal: True
  name: "Buiten unit firmware versie 2"
  skip_updates: 10
  address: 3509
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outside_unit_version_3
  internal: True
  name: "Buiten unit firmware versie 3"
  skip_updates: 10
  address: 3510
  register_type: holding
  value_type: S_WORD
  state_class: "measurement"
  web_server: 
    sorting_group_id: sensors_outside

text_sensor:
  - platform: template
    name: "Buiten unit EEPROM versie"
    update_interval: 60s
    web_server: 
     sorting_group_id: sensors_outside
    lambda: |-
      if (!id(outside_unit_version_1).has_state() ||
          !id(outside_unit_version_2).has_state() ||
          !id(outside_unit_version_3).has_state()) {
        return {};
      }

      int v1 = (int)id(outside_unit_version_1).state;
      int v2 = (int)id(outside_unit_version_2).state;
      int v3 = (int)id(outside_unit_version_3).state;

      char buffer[20];
      snprintf(buffer, sizeof(buffer), "V%04X,%d%d", v1, v2, v3);
      return std::string(buffer);
    icon: "mdi:chip"

  - platform: template
    id: state_machine_state
    name: "Control loop state"
    icon: "mdi:state-machine"
    update_interval: never

binary_sensor:
  - platform: template
    name: "Vorstbescherming 1e trap"
    id: frost_protection_stage1_active
    filters:
      - delayed_on_off: 300s
    lambda: |-
      return id(temperature_outside_ta).state < id(frost_protection_stage_1_temp_ta).state;
    on_press: 
      then:
        - logger.log:
            format: "Pump interval reset due to pump required for frost protection."
            level: INFO
        - lambda: |-
            AMBER.ResetPumpInterval();  

  - platform: template
    name: "Vorstbescherming 2e trap"
    id: frost_protection_stage2_active
    filters:
      - delayed_on_off: 300s
    lambda: |-
      return id(temperature_outside_ta).state < id(frost_protection_stage_2_temp_ta).state &&
             id(inlet_temperature_tui).state < id(frost_protection_stage_2_temp_tui).state;
    on_press: 
      then:
        - logger.log:
            format: "Pump interval reset due to pump required for frost protection."
            level: INFO
        - lambda: |-
            AMBER.ResetPumpInterval();

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    id: internal_pump_active
    name: "Pomp P0 actief"
    address: 1212
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Koel relais"
    address: 1213
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Warmtevraag relais"
    address: 1214
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Pomp P1 actief"
    address: 1300
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Pomp P2 actief"
    address: 1301
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Tapwater pomp actief"
    address: 1302
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Drieweg klep"
    address: 1305
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_inside_unit
    name: "Backup element"
    address: 1309
    register_type: holding
    device_class: running
    web_server: 
      sorting_group_id: sensors_inside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Fan Low Speed Mode"
    register_type: holding
    address: 2108
    bitmask: 0x1
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Bottom Heater"
    register_type: holding
    address: 2108
    bitmask: 0x4
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Crankcase Heater"
    register_type: holding
    address: 2108
    bitmask: 0x8
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Fan Defrost Speed Mode"
    register_type: holding
    address: 2108
    bitmask: 0x10
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Fan High Speed Mode"
    register_type: holding
    address: 2108
    bitmask: 0x20
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "4-way Valve switching"
    register_type: holding
    address: 2108
    bitmask: 0x40
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Expansion Valve Lock"
    register_type: holding
    address: 2108
    bitmask: 0x80
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Pump Relay"
    register_type: holding
    address: 2108
    bitmask: 0x800
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Defrost"
    icon: mdi:snowflake
    register_type: holding
    address: 2118
    web_server: 
      sorting_group_id: sensors_outside

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Alarm - Main Line Current"
    icon: mdi:message-alert
    register_type: holding
    address: 2119
    bitmask: 0x1
    web_server: 
      sorting_group_id: sensors_outside
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    id: oil_return_cycle_active
    name: "Olie-terugloop cyclus actief (P04)"
    icon: mdi:autorenew
    register_type: holding
    address: 2119
    bitmask: 0x8
    web_server: 
      sorting_group_id: sensors_outside
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Alarm - High Pressure Switch"
    icon: mdi:message-alert
    register_type: holding
    address: 2119
    bitmask: 0x10
    web_server: 
      sorting_group_id: sensors_outside
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Alarm - 1st Start Pre-heat"
    icon: mdi:message-alert
    register_type: holding
    address: 2119
    bitmask: 0x40
    web_server: 
      sorting_group_id: sensors_outside
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Alarm - AC High/Low Voltage"
    icon: mdi:message-alert
    register_type: holding
    address: 2119
    bitmask: 0x200
    web_server: 
      sorting_group_id: sensors_outside
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Alarm - Defrosting?"
    icon: mdi:message-alert
    register_type: holding
    address: 2119
    bitmask: 0x800
    web_server: 
      sorting_group_id: sensors_outside
  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    name: "Alarm - Low Pressure Switch"
    icon: mdi:message-alert
    register_type: holding
    address: 2119
    bitmask: 0x1000
    web_server: 
      sorting_group_id: sensors_outside

  - platform: template
    id: modbus_inside_online
    name: "Modbus binnenunit"
    device_class: connectivity
    lambda: |-
      return id(modbus_inside_is_online);

  - platform: template
    id: modbus_outside_online
    name: "Modbus buitenunit"
    device_class: connectivity
    lambda: |-
      return id(modbus_outside_is_online);

number:
- platform: template
  name: Flow sensor calibration
  id: flow_sensor_calibration
  min_value: 1
  max_value: 1000
  mode: box
  step: 1
  restore_value: true
  optimistic: true
  unit_of_measurement: pulses/l
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Vorstbescherming 1e trap buiten temperatuur(Ta)"
  id: frost_protection_stage_1_temp_ta
  optimistic: true
  min_value: 0
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 8.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Vorstbescherming 2e trap buiten temperatuur(Ta)"
  id: frost_protection_stage_2_temp_ta
  optimistic: true
  min_value: 0
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 6.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Vorstbescherming 2e trap water temperatuur (Tui)"
  id: frost_protection_stage_2_temp_tui
  optimistic: true
  min_value: 0
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 7.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Compressor start delta"
  id: compressor_start_delta
  optimistic: true
  min_value: 0.1
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 3.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Compressor stop delta"
  id: compressor_stop_delta
  optimistic: true
  min_value: 0.1
  max_value: 10
  step: 0.1
  unit_of_measurement: "°C"
  device_class: "temperature"
  initial_value: 5.0
  restore_value: True
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: modbus_controller
  modbus_controller_id: modbus_outside_unit
  id: outlet_temperature_outside
  name: "CV-aanvoertemperatuur - Buiten"
  address: 2005
  register_type: holding
  value_type: S_WORD
  internal: True
  mode: box
  web_server: 
      sorting_group_id: control_outside

- platform: template
  name: "Pomp interval (minuten)"
  id: pump_interval
  optimistic: True
  restore_value: True
  min_value: 5
  max_value: 60
  step: 1
  unit_of_measurement: "min"
  icon: "mdi:timer-outline"
  initial_value: 15
  entity_category: config
  web_server: 
      sorting_group_id: settings

- platform: template
  name: "Pomp duur (minuten)"
  id: pump_duration
  optimistic: True
  restore_value: True
  min_value: 2
  max_value: 10
  step: 1
  unit_of_measurement: "min"
  icon: "mdi:clock-outline"
  initial_value: 2
  entity_category: config
  web_server: 
      sorting_group_id: settings

switch:
 - platform: gpio
   pin: GPIO22
   name: Relay heating
   id: relay_heating
   icon: mdi:electric-switch
   restore_mode: RESTORE_DEFAULT_OFF

 - platform: gpio
   pin: GPIO23
   name: Relay cooling
   id: relay_cooling
   icon: mdi:electric-switch
   restore_mode: RESTORE_DEFAULT_OFF

 - platform: template
   id: amber_controller_active
   name: "Amber controller actief"
   optimistic: True
   on_turn_on: 
     then:
      # Initialize board relays
      - switch.turn_on: pump_p0_relay
      - switch.turn_on: pump_p1_relay
      - switch.turn_on: pump_p2_relay
      - select.set: 
          id: pump_state
          option: "Off"
      - switch.turn_on: initialize_step_4

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: pump_p0_relay
   name: "Pump P0 relay"
   address: 1099
   register_type: holding
   web_server: 
     sorting_group_id: control_inside
     
 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: pump_p1_relay
   name: "Pump P1 relay"
   address: 1100
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: pump_p2_relay
   name: "Pump P2 relay"
   address: 1101
   register_type: holding
   web_server: 
     sorting_group_id: control_inside
     
 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   id: initialize_step_4
   name: "Binnen unit Onbekend #4"
   address: 1104
   register_type: holding
   web_server: 
    sorting_group_id: control_inside

 - platform: modbus_controller
   modbus_controller_id: modbus_inside_unit
   name: "Three way valve?"
   address: 1112
   register_type: holding
   web_server: 
     sorting_group_id: control_inside

select:
  - platform: modbus_controller
    id: pump_state
    modbus_controller_id: modbus_inside_unit
    name: "Pomp stand"
    address: 1103
    optionsmap:
      "Off": 1000
      "Unknown": 950
      "Low": 500
      "Medium": 250
      "High": 0
    web_server: 
     sorting_group_id: control_inside
    on_value: 
      then:
        - lambda: 
            id(modbus_inside_is_online) = true;

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    id: compressor_control
    name: "Compressor stand (Buiten)"
    address: 1999
    value_type: S_WORD
    web_server: 
     sorting_group_id: control_outside
    optionsmap:
      "0Hz": 0
      "36Hz": 1
      "43Hz": 2
      "49Hz": 3
      "55Hz": 4
      "61Hz": 5
      "67Hz": 6
      "72Hz": 7
      "79Hz": 8
      "85Hz": 9
      "90Hz": 10

  - platform: modbus_controller
    modbus_controller_id: modbus_outside_unit
    id: working_mode_switch
    name: "Werkmodus (Buiten)"
    address: 3999
    on_value: 
      then:
        - lambda: 
            id(modbus_outside_is_online) = true;
    web_server: 
     sorting_group_id: control_outside
    optionsmap:
      "Standby": 0
      "Koelen": 1
      "Verwarmen": 2

button:
  - platform: factory_reset
    name: Restart with Factory Default Settings
