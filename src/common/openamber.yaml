substitutions:
  device_name: openamber
  device_friendly_name: OpenAmber
  device_project_name: jordi.openamber
  device_version: 0.0.7

esphome:
  name: ${device_name}
  friendly_name: ${device_friendly_name}
  project:
    name: ${device_project_name}
    version: ${device_version}
  includes: 
    - common/openamber.h
  on_boot:
    then:
      - if:
          condition:
            - switch.is_on: analytics_enabled_switch
          then:
            - mqtt.enable:
esp32:
  framework:
    type: esp-idf

interval:
  - interval: 5min
    then:
      - if:
         condition:
          - switch.is_on: analytics_enabled_switch
         then:
          - script.execute: send_analytics
  - interval: 10s
    then:
      - if:
         condition:
          - switch.is_on: amber_controller_active
          - binary_sensor.is_on: modbus_inside_online
          - binary_sensor.is_on: modbus_outside_online
         then:
          - lambda: |-
              AMBER.loop();

logger:
  level: INFO
  baud_rate: 0

api:
  reboot_timeout: 0s

# Broker used to push analytics data (Opt-In)
mqtt:
  broker: mqtt.openamber.nl
  enable_on_boot: false
  username: openamber_write
  password: openamber
  discovery: false
  discover_ip: false
  discovery_retain: false
  log_topic: null
  topic_prefix: null

ota:
  - platform: esphome
  - platform: http_request

http_request:
  buffer_size_tx: 1024

update:
  - platform: http_request
    name: Firmware Update
    source: https://github.com/Jordi1990/openamber/releases/latest/download/openamber.manifest.json

web_server:
  port: 80
  version: 3
  sorting_groups:
    - id: overview
      name: "Overzicht"
      sorting_weight: 0
    - id: general_settings
      name: "Algemene instellingen"
      sorting_weight: 10
    - id: dhw_settings
      name: "Tapwater instellingen"
      sorting_weight: 20
    - id: heating_settings
      name: "Verwarmingsinstellingen"
      sorting_weight: 30
    - id: temperature_sensors
      name: "Temperatuursensoren"
      sorting_weight: 40
    - id: diagnostic
      name: "Diagnostiek"
      sorting_weight: 50
    - id: error_codes
      name: "Foutcodes"
      sorting_weight: 60
    - id: manual_control
      name: "Handmatige bediening"
      sorting_weight: 70
    - id: config
      name: "Config"
      sorting_weight: 80
wifi:
  ap:
    ssid: "OpenAmber"
    password: "openamber"

captive_portal:    

uart:
  baud_rate: 19200
  parity: EVEN

globals:
  - id: modbus_inside_is_online
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: modbus_outside_is_online
    type: bool
    restore_value: no
    initial_value: 'false'

datetime:
 - platform: template
   id: next_legionella_run
   name: "Volgende legionellapreventie"
   type: datetime
   restore_value: true
   optimistic: true
   initial_value: "2030-01-01 10:00:00"
   entity_category: config
   web_server: 
    sorting_group_id: dhw_settings


# Use SNTP for time so we also have time when not connected to Home Assistant.
time:
  - platform: sntp
    id: my_time

modbus:
  send_wait_time: 500ms

modbus_controller:
- id: modbus_outside_unit
  address: 0x2
  update_interval: 30s
  command_throttle: 500ms
  max_cmd_retries: 3
  on_offline:
    then:
      - lambda: |-
          id(modbus_outside_is_online) = false;
      - logger.log: "Modbus outside unit OFFLINE"
  on_online:
    then:
      - lambda: |-
          id(modbus_outside_is_online) = true;
      - logger.log: "Modbus outside unit ONLINE"
- id: modbus_inside_unit
  address: 0x0B
  update_interval: 30s
  command_throttle: 500ms
  max_cmd_retries: 3
  on_offline:
    then:
      - lambda: |-
          id(modbus_inside_is_online) = false;
      - logger.log: "Modbus inside unit OFFLINE"
  on_online:
    then:
      - lambda: |-
          id(modbus_inside_is_online) = true;
      - logger.log: "Modbus inside unit ONLINE"

climate: !include climates.yaml
sensor: !include sensors.yaml
text_sensor: !include text_sensors.yaml
binary_sensor: !include binary_sensors.yaml
number: !include numbers.yaml
switch: !include switches.yaml
select: !include selects.yaml
script: !include scripts.yaml

output:
  - platform: template
    id: pid_heat_output
    type: float
    write_action:
      - lambda: |-
          AMBER.WriteHeatPIDValue(state);

  - platform: template
    id: pid_cool_output
    type: float
    write_action:
      - logger.log:
          format: "Write cool pids"
          level: DEBUG
      # TODO: Store in seperate pid field
      # - lambda: |-
      #     AMBER.WritePIDValue(state);

button:
  - platform: factory_reset
    disabled_by_default: true
    name: Restart with Factory Default Settings
